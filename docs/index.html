<!DOCTYPE html>
<html>
    <head>
        <title>Damage Simulator</title>
        <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
        <script type="importmap">
            {
                "imports": {
                    "vue": "https://unpkg.com/vue@3/dist/vue.esm-browser.js"
                }
            }
        </script>
        <script src="./lib/exmath.js"></script>
        <link rel="stylesheet" href="./style.css" type="text/css">
    </head>
    <body>
        <main>
            <svg id="graph" version="1.1" xmlns="http://www.w3.org/2000/svg" width="100%" height="300" v-show="ready && display.graph">
                <rect id="layer-background" x="0" y="0" width="100%" height="100%" fill="#000e"></rect>
                <g id="layer-grid">
                    <g v-for="data of graph.hGridCoord()">
                        <line
                            :x1="data.start.x" :y1="data.start.y"
                            :x2="data.end.x" :y2="data.end.y"
                            :class="'grid '+data.style"
                        />
                        <text v-if="data.style === 'solid'"
                            :x="data.start.x"
                            :y="data.start.y + 10"
                            text-anchor="middle">{{data.text}}</text>
                    </g>
                    <g v-for="data of graph.vGridCoord()">
                        <line 
                            :x1="data.start.x" :y1="data.start.y"
                            :x2="data.end.x" :y2="data.end.y"
                            :class="'grid '+data.style"
                        />
                        <text v-if="data.style === 'solid'"
                            :x="data.start.x - 5"
                            :y="data.start.y"
                            text-anchor="end">{{data.text}}</text>
                    </g>
                </g>
                <g id="layer-main">
                    <line
                        :x1="graph.origin.x"
                        :y1="100"
                        :x2="graph.origin.x + graph.stage.width"
                        :y2="100"
                        stroke="#900" stroke-width="1" stroke-dasharray="2,2" />
                    <polyline v-for="data,key of agentSet.result"
                        :points="graph.drawGraph(data)"
                        :stroke="graph.graphStyle[key].color"
                        :stroke-width="graph.graphStyle[key].width"
                        fill="transparent"
                    />
                </g>
                <g id="layer-baseline">
                    <polyline
                        :points="graph.baseLine()"
                        :stroke="graph.lineStyle.base.color"
                        :stroke-width="graph.lineStyle.base.width"
                        fill="transparent"
                    />
                </g>
                <g id="layer-text">
                    <text :x="graph.origin.x" :y="graph.margin.top-5" text-anchor="middle" fill="#fff">ダメージ出力</text>
                    <text :x="graph.origin.x + graph.stage.width" :y="graph.height" text-anchor="middle" fill="#fff">サブステータススタック数</text>
                </g>
            </svg>
            <section v-show="ready && display.base">
                <div class="agent-status" :style="'position: sticky; top: ' + (display.graph ? '300px' : '0') + ';'" v-show="display.status">
                    <table>
                        <caption>エージェント : {{agentSet.agent.name.full.jp}} [{{Base.getRoleName(agentSet.agent.role)}}/{{Base.getElementName(agentSet.agent.element)}}]</caption>
                        <colgroup>
                            <col class="row-header" span="1" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th v-for="label of agentSet.agent.getStatusList()">{{Base.getLabel(label)}}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="obj,key in agentSet.calcStatus(undefined,0,true)" :class="key">
                                <td v-for="val,label in obj">
                                    {{val}}{{Base.getUnit(label, '%')}}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <section style="overflow-x: scroll; display: flex;">
                    <fieldset>
                        <legend>エージェント設定</legend>
                        <dl>
                            <dt>フィルター</dt>
                            <dd>
                                ロール<select v-model="filterState.role">
                                    <option v-for="val, key in ['強攻', '異常', '撃破', '防護', '支援', '命破']" :value="key">{{val}}</option>
                                    <option :value="Infinity">All</option>
                                </select> /
                                属性<select v-model="filterState.element">
                                    <option v-for="val, key in ['電気', 'エーテル', '炎', '氷', '物理']" :value="key">{{val}}</option>
                                    <option :value="Infinity">All</option>
                                </select> /
                                レア度<select v-model="filterState.rarity">
                                    <option v-for="val, key in ['S', 'A']" :value="key">{{val}}</option>
                                    <option :value="Infinity">All</option>
                                </select> /
                                陣営<select v-model="filterState.faction">
                                    <option v-for="val, key in [1,2,3,4,5,6,7,8,9,10,11,12]" :value="key">{{val}}</option>
                                    <option :value="Infinity">All</option>
                                </select>
                            </dd>
                            <dt>対象エージェント</dt>
                            <dd>
                                <select v-model="agentSet.agent.id">
                                    <option v-for="{id, name}, key in Agent.getAgentList('full', 'jp', filterState)" :value="id">{{name}}</option>
                                </select>
                            </dd>
                            <dt>コアスキルレベル</dt>
                            <dd>
                                <label><input type="radio" v-model="agentSet.agent.coreLvl" :value="0">-</label>
                                <label v-for="val, key of ['A','B','C','D','E','F']"><input type="radio" v-model="agentSet.agent.coreLvl" :value="key+1">{{val}}</label>
                                <span class="nowrap">(追加ステータス : <span v-for="val, key in agentSet.agent.coreEffect">{{Base.getLabel(key)}} +{{val}}{{Base.getUnit(key)}} , </span>)</span>
                                </select>
                            </dd>
                            <dt>心象映画レベル</dt>
                            <dd>
                                &nbsp;
                            </dd>
                        </dl>
                        <table>
                            <caption>エージェント基礎ステータス</caption>
                            <colgroup>
                            </colgroup>
                            <thead>
                                <tr>
                                    <th v-for="label of agentSet.agent.getStatusList()">{{Base.getLabel(label)}}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr id="agent-base-status">
                                    <td v-for="val, key of agentSet.agent.getAllStatus()">
                                        {{val}}{{Base.getUnit(key, '%')}}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </fieldset>
                    <fieldset>
                        <legend>装備セット(基礎)</legend>
                        <label>ATK : <input type="number" v-model="agentSet.wengine.atk"></label>
                        <label>Adv-st : <select v-model="agentSet.wengine.adv.type">
                            <option v-for="item of WENGINE_ADVLIST" :value="item">{{Base.getLabel(item)}}</option>
                        </select>
                        <input class="digit2" type="number" v-model="agentSet.wengine.adv.value">{{Base.getUnit(agentSet.wengine.adv.type)}}</label>
                        <dl>
                            <dt>ドライバコンビネーション</dt>
                            <dd v-for="i in 3">
                                <select v-model="agentSet.driver.combination[i-1]">
                                    <option v-for="val, key of DRIVER_LIST" :value="key">{{val}}</option>
                                </select> x 2
                            </dd>
                            <div v-for="label, key of agentSet.driver.main.slice(3)">
                                <dt>スロット{{key+4}} メインステータス</dt>
                                <dd>
                                    <label v-for="item of DRIVER_MAINLIST[key+3]">
                                        <input type="radio" v-model="agentSet.driver.main[key+3]" :value="item">
                                        {{Base.getLabel(item)}} +{{DRIVER_MAINSTAT[item]}}{{Base.getUnit(item)}}
                                    </label>
                                </dd>
                            </div>
                        </dl>
                    </fieldset>
                    <table>
                        <caption>サブステータス設定 / ディスク効果合計</caption>
                        <colgroup>
                            <col class="row-header" />
                            <col class="driver" />
                            <col class="total" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th>&nbsp;</th>
                                <!--
                                <th>2Set</th>
                                <th>Main</th>
                                -->
                                <th>Sub ({{agentSet.driver.stackTotal}}/{{Driver.getStackLimit()}})</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="label in Driver.getStatusList()">
                                <th scope="col">{{Base.getLabel(label)}}({{Base.getUnit(label)}})</th>
                                <!--
                                <td v-if="agentSet.driver.getSetEffect(label)">{{agentSet.driver.getSetEffect(label)}}{{Base.getUnit(label, '%')}}</td>
                                <td v-else>&nbsp;</td>
                                <td v-if="agentSet.driver.getMainValue(label)">{{agentSet.driver.getMainValue(label)}}{{Base.getUnit(label, '%')}}</td>
                                <td v-else>&nbsp;</td>
                                -->
                                <td v-if="agentSet.driver.sub[label]">
                                    <span class="nowrap">{{DRIVER_SUBSTAT[label]}}{{Base.getUnit(label)}} * <input class="digit2" type="number" v-model="agentSet.driver.sub[label].stack" min="0" :max="agentSet.driver.sub[label].max">
                                    <button @click="agentSet.driver.sub[label].stack --">-</button><button @click="agentSet.driver.sub[label].stack ++">+</button></span>
                                    <input type="range"
                                        v-model="agentSet.driver.sub[label].stack"
                                        :min="0" :max="agentSet.driver.sub[label].max"
                                        :style="`background: linear-gradient(90deg ,
                                            #000 10px,
                                            #000 calc(
                                                10px +
                                                ((100% - 20px) / ${agentSet.driver.sub[label].max}) * 
                                                (${(Driver.getStackLimit() - agentSet.driver.stackTotal)} + ${agentSet.driver.sub[label].stack})
                                            ),
                                            #999 10px)`">
                                </td>
                                <td v-else>&nbsp;</td>
                                <td>{{agentSet.driver.getEffectValue(label)}}{{Base.getUnit(label, '%')}}</td>
                            </tr>
                        </tbody>
                    </table>
                </section>
            </section>
            <section v-for="pattern, pNum of agentSet.pattern" v-show="ready && display.pattern[pNum]">
                <fieldset>
                    <legend>装備パターン #{{pNum+1}}</legend>
                    <label>ATK : <input type="number" v-model="pattern.wengine.atk"></label>
                    <label>Adv-st : <select v-model="pattern.wengine.adv.type">
                        <option v-for="item of WENGINE_ADVLIST" :value="item">{{Base.getLabel(item)}}</option>
                    </select>
                    <input class="digit2" type="number" v-model="pattern.wengine.adv.value">{{Base.getUnit(pattern.wengine.adv.type)}}</label>
                    <dl>
                        <dt>ドライバコンビネーション</dt>
                        <dd v-for="i in 3">
                            <select v-model="pattern.driver.combination[i-1]">
                                <option v-for="val, key of DRIVER_LIST" :value="key">{{val}}</option>
                            </select> x 2
                        </dd>
                        <div v-for="label, key of pattern.driver.main.slice(3)">
                            <dt>スロット{{key+4}} メインステータス</dt>
                            <dd>
                                <label v-for="item of DRIVER_MAINLIST[key+3]">
                                    <input type="radio" v-model="pattern.driver.main[key+3]" :value="item">
                                    {{Base.getLabel(item)}} +{{DRIVER_MAINSTAT[item]}}{{Base.getUnit(item)}}
                                </label>
                            </dd>
                        </div>
                    </dl>
                    <table>
                        <caption>サブステータス補正</caption>
                        <colgroup>
                            <col class="row-header" />
                            <col class="driver" span="2" />
                            <col class="total" />
                        </colgroup>
                        <thead>
                            <tr>
                                <th>&nbsp;</th>
                                <!--
                                <th>2Set</th>
                                <th>Main</th>
                                -->
                                <th>&nbsp;</th>
                                <th>Sub ({{pattern.driver.stackTotal}}/{{Driver.getStackLimit()}})</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="label of Driver.getStatusList()">
                                <th scope="col">{{Base.getLabel(label)}}({{Base.getUnit(label)}})</th>
                                <!--
                                <td v-if="pattern.driver.original.getSetEffect(label)">{{pattern.driver.original.getSetEffect(label)}}{{Base.getUnit(label, '%')}}</td>
                                <td v-else>&nbsp;</td>
                                <td v-if="pattern.driver.original.getMainValue(label)">{{pattern.driver.original.getMainValue(label)}}{{Base.getUnit(label, '%')}}</td>
                                <td v-else>&nbsp;</td>
                                -->
                                <td>
                                    <label><input type="radio" v-model="pattern.improveTgt" :value="label" @click="console.log(pattern.improveTgt)">設定</label>
                                </td>
                                <td v-if="pattern.driver.original.sub[label]">
                                    <span class="nowrap">
                                        {{DRIVER_SUBSTAT[label]}}{{Base.getUnit(label)}} * 
                                        <input class="digit2" type="number"
                                        v-model="pattern.driver.sub[label].stack"
                                        :min="pattern.driver.sub[label].min"
                                        :max="pattern.driver.sub[label].max">
                                        <button @click="pattern.driver.sub[label].stack --">-</button>
                                        <button @click="pattern.driver.sub[label].stack ++">+</button>
                                    </span>
                                    <input type="range" :data-stat="label"
                                    v-model="pattern.driver.sub[label].stack"
                                    :min="pattern.driver.sub[label].min"
                                    :max="pattern.driver.sub[label].max">
                                </td>
                                <td v-else>&nbsp;</td>
                                <td>{{}}{{Base.getUnit(label, '%')}}</td>
                            </tr>
                        </tbody>
                    </table>
                </fieldset>
            </section>
            <footer v-show="ready">
                <menu>
                    <li><button @click="display.switchScreen('base')">基本値設定</button></li>
                    <li>
                        <div>装備パターン</div>
                        <ol>
                            <li v-for="i in agentSet.pattern.length">
                                <button @click="display.switchScreen('pattern', i-1)">#{{i}}</button>
                            </li>
                        </ol>
                    </li>
                    <li>
                        <div>ステータス</div>
                        <button @click="display.statusSwitch()">表示<br>{{display.status}}</button>
                    </li>
                    <li>
                        <div>グラフ</div>
                        <button @click="display.graphSwitch()">表示<br>{{display.graph}}</button>
                    </li>
                </menu>
            </footer>
        </main>
        <script type="module">
            'use strict'
            import { ref, createApp, onBeforeUpdate, onUpdated, onMounted, useTemplateRef } from 'vue'
            import { Base } from './lib/base.js'
            import { Agent } from './lib/agent.js'
            import { Wengine } from './lib/wengine.js'
            import { Driver } from './lib/driver.js'
            import { Calculator } from './lib/calc.js'
            import { Graph } from './lib/graph.js'
            
            const ready = ref(false)
            await Promise.all([Agent.ready])
            
            Base.lang = 'jp'
            Base.setExcludeStatus(['aPrf', 'aBld', 'imp', 'eReg', 'pen', 'penV'])
            const WENGINE_ADVLIST = Wengine.getAdvStatusList()
            const DRIVER_LIST = Driver.getDiscList()
            const DRIVER_STATUSLIST = Driver.getStatusList()
            const DRIVER_MAINSTAT = Driver.getMainAll(15)
            const DRIVER_MAINLIST = Driver.getMainStatusList()
            const DRIVER_SUBSTAT = Driver.getSubAll()
            const DRIVER_SUBLIST = Driver.getSubLabels()

            const agentSet = ref(new Calculator(0, 0, undefined, 5))

            const outputCalcMode = ref('normal')

            const field = document.querySelector('#graph')
            const stageMargin = {top: 30, right: 45, bottom: 45, left: 45}
            console.log(agentSet.value.result)
            const graph = ref(new Graph(field, stageMargin, agentSet))

            createApp({
                setup() {
                    const display = ref({
                        graph: false,
                        graphSwitch() { this.graph = !this.graph },
                        status: true,
                        statusSwitch() { this.status = !this.status },
                        base: true,
                        pattern: new Array(agentSet.value.pattern.length).fill(false),
                        switchScreen(tgt, id = 0) {
                            if(tgt === 'base') {
                                this.base = true
                                this.pattern.fill(false)
                            } else if(tgt === 'pattern') {
                                this.base = false
                                this.pattern.fill(false)
                                this.pattern[id] = true
                            }
                        }
                    })
                    const vp = ref({
                        w: window.innerWidth, h: window.innerHeight
                    })
                    const filterState = ref({role: Infinity, rarity: Infinity, element: Infinity, faction: Infinity})

                    onMounted(() => {
                        console.log('Vue app : mounted')
                        ready.value = true
                    })
                    onBeforeUpdate(() => {
                        console.log('Vue app : before update')
                        agentSet.value.getOutputList()
                        graph.value.refreshData(agentSet.value.result)
                    })
                    onUpdated(() => {
                        console.log('Vue app : updated')
                    })

                    return {
                        vp, ready, display, graph,
                        Base, Agent, Wengine, Driver,
                        WENGINE_ADVLIST, DRIVER_LIST, DRIVER_MAINSTAT, DRIVER_MAINLIST, DRIVER_SUBSTAT,
                        agentSet,
                        outputCalcMode, filterState,
                        onMounted, onUpdated, onBeforeUpdate,
                    }
                }
            }).mount('main')
        </script>
    </body>
</html>